<!DOCTYPE html>
<html>
<head>
    <title>Attendance Marking</title>
    <script>
        // Function to get URL parameters (e.g., student_id from query string)
        function getUrlParameter(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // Function to fetch the user's geolocation with high accuracy
        function fetchGeolocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            resolve({ latitude, longitude });
                        },
                        (error) => {
                            reject("Geolocation error: " + error.message);
                        },
                        {
                            enableHighAccuracy: true, // Enables precise GPS tracking
                            timeout: 10000, // Wait for up to 10 seconds
                            maximumAge: 0 // Always fetch fresh location
                        }
                    );
                } else {
                    reject("Geolocation not supported by this browser.");
                }
            });
        }

        // Function to fetch location using Google Geolocation API
        async function fetchGoogleGeolocation() {
            try {
                const response = await fetch("https://www.googleapis.com/geolocation/v1/geolocate?key=YOUR_GOOGLE_API_KEY", {
                    method: "POST",
                });
                const data = await response.json();
                return { latitude: data.location.lat, longitude: data.location.lng };
            } catch (error) {
                return { error: "Google Geolocation API failed: " + error.message };
            }
        }

        // Function to get the user's IP-based location
        async function fetchIPLocation() {
            try {
                const response = await fetch("https://ipapi.co/json/");
                const data = await response.json();
                return { latitude: data.latitude, longitude: data.longitude, ip: data.ip };
            } catch (error) {
                return { error: "IP-based location fetching failed." };
            }
        }

        // Classroom boundary coordinates
        const classroomBounds = {
            north: 19.971319,  // Maximum latitude
            south: 19.971109,  // Minimum latitude
            east:  73.719849,  // Maximum longitude
            west:  73.719780   // Minimum longitude
        };

        // Function to check if the user is inside the classroom boundaries
        function isLocationInsideClassroom(latitude, longitude, bounds) {
            return (
                latitude >= bounds.south &&
                latitude <= bounds.north &&
                longitude >= bounds.west &&
                longitude <= bounds.east
            );
        }

        // Function to detect GPS spoofing by comparing GPS & IP location
        function detectFakeGPS(gpsLocation, ipLocation) {
            const threshold = 0.05; // Allow small difference
            const latDiff = Math.abs(gpsLocation.latitude - ipLocation.latitude);
            const lonDiff = Math.abs(gpsLocation.longitude - ipLocation.longitude);

            return latDiff > threshold || lonDiff > threshold;
        }

        // Main function that runs on page load
        window.onload = async function () {
            const studentId = getUrlParameter("student_id");
            const studentIdDisplay = document.getElementById("studentId");
            const locationDisplay = document.getElementById("location");
            const ipDisplay = document.getElementById("ipAddress");
            const statusDisplay = document.getElementById("status");

            if (studentId) {
                studentIdDisplay.innerText = "Student ID: " + decodeURIComponent(studentId);

                try {
                    // Fetch geolocation
                    let location = await fetchGeolocation();
                    let { latitude, longitude } = location;

                    // Display fetched latitude and longitude
                    locationDisplay.innerText = `Latitude: ${latitude}, Longitude: ${longitude}`;

                    // Fetch Google Geolocation API for better accuracy
                    let googleLocation = await fetchGoogleGeolocation();
                    if (!googleLocation.error) {
                        latitude = googleLocation.latitude;
                        longitude = googleLocation.longitude;
                    }

                    // Fetch IP-based location
                    const ipLocation = await fetchIPLocation();
                    if (!ipLocation.error) {
                        ipDisplay.innerText = `IP Address: ${ipLocation.ip} (Location: ${ipLocation.latitude}, ${ipLocation.longitude})`;
                    } else {
                        ipDisplay.innerText = ipLocation.error;
                    }

                    // Detect GPS spoofing
                    if (detectFakeGPS({ latitude, longitude }, ipLocation)) {
                        alert("‚ö†Ô∏è Warning: Your GPS location does not match your IP location. Possible spoofing detected!");
                        statusDisplay.innerText = "Status: ‚ùå Fake GPS suspected!";
                        return;
                    }

                    // Check if the student is inside the classroom
                    if (isLocationInsideClassroom(latitude, longitude, classroomBounds)) {
                        locationDisplay.innerText = `‚úÖ Location Verified: Latitude ${latitude}, Longitude ${longitude} (Inside classroom)`;
                        alert("‚úÖ You are in the classroom. Attendance is being marked...");

                        // Prepare form data
                        const formData = new URLSearchParams();
                        formData.append("student_id", studentId);
                        formData.append("latitude", latitude);
                        formData.append("longitude", longitude);
                        formData.append("subject", "Java"); // Example subject
                        formData.append("date", new Date().toISOString().split("T")[0]); // Current date

                        // Send form data via POST
                        const response = await fetch("SetAttendance", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/x-www-form-urlencoded", // Form-encoded data
                            },
                            body: formData.toString(), // Convert formData to a URL-encoded string
                        });

                        const serverResponse = await response.text();
                        alert("üì© Server Response: " + serverResponse);
                    } else {
                        locationDisplay.innerText = `‚ùå Location: Latitude ${latitude}, Longitude ${longitude} (Outside classroom)`;
                        alert("‚ùå You are outside the classroom boundary. Attendance cannot be marked.");
                    }

                } catch (error) {
                    locationDisplay.innerText = "‚ùå Unable to fetch location: " + error;
                    statusDisplay.innerText = "Status: ‚ùå Location access failed.";
                }
            } else {
                studentIdDisplay.innerText = "‚ö†Ô∏è No student ID found!";
                statusDisplay.innerText = "Status: ‚ùå Unable to proceed without student ID.";
            }
        };
    </script>
</head>
<body>
    <h1>üìå Attendance Marking</h1>
    <p id="studentId">Fetching your details...</p>
    <p id="location">üìç Fetching your location...</p>
    <p id="ipAddress">üåê Fetching your IP address...</p>
    <p id="status">üîÑ Checking status...</p>
</body>
</html>
